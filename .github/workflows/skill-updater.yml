name: Skill Auto Updater

on:
  # å®šæ—¶è§¦å‘ï¼šæ¯å‘¨æ—¥å‡Œæ™¨ 2 ç‚¹ï¼ˆUTCï¼‰
  schedule:
    - cron: '0 2 * * 0'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'è¯•è¿è¡Œæ¨¡å¼ï¼ˆä¸å®é™…åº”ç”¨æ›´æ–°ï¼‰'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      skill_path:
        description: 'æŒ‡å®šæ›´æ–°çš„ Skill è·¯å¾„ï¼ˆå¯é€‰ï¼‰'
        required: false
        default: ''
        type: string

env:
  # Telegram é…ç½®ï¼ˆä» Secrets è¯»å–ï¼‰
  TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
  TELEGRAM_USER_ID: ${{ secrets.TELEGRAM_USER_ID }}

jobs:
  update-skills:
    runs-on: ubuntu-latest
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      # 2. è®¾ç½® Python ç¯å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      # 3. å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml requests
      
      # 4. é…ç½® Git
      - name: Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
      
      # 5. è¿è¡Œ Skill æ›´æ–°å™¨
      - name: Run Skill Updater
        id: updater
        run: |
          cd skill
          
          # æ„å»ºå‘½ä»¤å‚æ•°
          ARGS=""
          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            ARGS="$ARGS --dry-run"
          fi
          if [ -n "${{ github.event.inputs.skill_path }}" ]; then
            ARGS="$ARGS --skill ${{ github.event.inputs.skill_path }}"
          fi
          
          # è¿è¡Œæ›´æ–°è„šæœ¬
          python .updater/updater.py $ARGS
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "changes=$(git diff --stat)" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # 6. æäº¤å˜æ›´
      - name: Commit changes
        if: steps.updater.outputs.has_changes == 'true' && github.event.inputs.dry_run != 'true'
        run: |
          cd skill
          
          # æ·»åŠ æ‰€æœ‰å˜æ›´
          git add -A
          
          # ç”Ÿæˆæäº¤ä¿¡æ¯
          COMMIT_MSG="Auto-update: Skill updates $(date +'%Y-%m-%d')

          Changes:
          ${{ steps.updater.outputs.changes }}
          
          Triggered by: ${{ github.event_name }}
          Workflow run: ${{ github.run_id }}"
          
          git commit -m "$COMMIT_MSG"
          
          # æ¨é€å˜æ›´
          git push
      
      # 7. ç”Ÿæˆæ›´æ–°æŠ¥å‘Š
      - name: Generate update report
        if: steps.updater.outputs.has_changes == 'true'
        run: |
          REPORT_FILE="update_report_$(date +'%Y%m%d_%H%M%S').md"
          
          cat > $REPORT_FILE << 'EOF'
          # Skill è‡ªåŠ¨æ›´æ–°æŠ¥å‘Š
          
          ## æ›´æ–°æ—¶é—´
          $(date +'%Y-%m-%d %H:%M:%S')
          
          ## è§¦å‘æ–¹å¼
          ${{ github.event_name }}
          
          ## æ›´æ–°å†…å®¹
          ${{ steps.updater.outputs.changes }}
          
          ## å·¥ä½œæµä¿¡æ¯
          - Run ID: ${{ github.run_id }}
          - Commit: ${{ github.sha }}
          
          EOF
          
          echo "report_file=$REPORT_FILE" >> $GITHUB_ENV
      
      # 8. Telegram é€šçŸ¥ - æ›´æ–°æˆåŠŸ
      - name: Send Telegram notification - Success
        if: steps.updater.outputs.has_changes == 'true' && github.event.inputs.dry_run != 'true'
        run: |
          MESSAGE="ğŸ‰ *Skill è‡ªåŠ¨æ›´æ–°æˆåŠŸ*

ğŸ“… æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')
ğŸ”„ è§¦å‘: ${{ github.event_name }}
ğŸ“Š å˜æ›´:
\`\`\`
${{ steps.updater.outputs.changes }}
\`\`\`

ğŸ”— æŸ¥çœ‹è¯¦æƒ…: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          curl -s -X POST \
            "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_USER_ID}" \
            -d "text=${MESSAGE}" \
            -d "parse_mode=Markdown" \
            -d "disable_web_page_preview=true"
      
      # 9. Telegram é€šçŸ¥ - æ— å˜æ›´
      - name: Send Telegram notification - No Changes
        if: steps.updater.outputs.has_changes == 'false'
        run: |
          MESSAGE="â„¹ï¸ *Skill è‡ªåŠ¨æ›´æ–°æ£€æŸ¥*

ğŸ“… æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')
âœ… çŠ¶æ€: æ²¡æœ‰éœ€è¦æ›´æ–°çš„ Skill

æ‰€æœ‰ Skill éƒ½æ˜¯æœ€æ–°çš„ï¼"

          curl -s -X POST \
            "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_USER_ID}" \
            -d "text=${MESSAGE}" \
            -d "parse_mode=Markdown"
      
      # 10. Telegram é€šçŸ¥ - è¯•è¿è¡Œæ¨¡å¼
      - name: Send Telegram notification - Dry Run
        if: github.event.inputs.dry_run == 'true'
        run: |
          MESSAGE="ğŸ§ª *Skill æ›´æ–° - è¯•è¿è¡Œæ¨¡å¼*

ğŸ“… æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')
ğŸ” çŠ¶æ€: ä»…æ£€æŸ¥ï¼Œæœªåº”ç”¨å˜æ›´

å¦‚éœ€åº”ç”¨å˜æ›´ï¼Œè¯·æ‰‹åŠ¨è¿è¡Œå·¥ä½œæµå¹¶å…³é—­è¯•è¿è¡Œæ¨¡å¼ã€‚"

          curl -s -X POST \
            "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_USER_ID}" \
            -d "text=${MESSAGE}" \
            -d "parse_mode=Markdown"

  # å¤±è´¥é€šçŸ¥ä»»åŠ¡
  notify-on-failure:
    runs-on: ubuntu-latest
    needs: update-skills
    if: failure()
    
    steps:
      - name: Send Telegram notification - Failure
        run: |
          MESSAGE="âŒ *Skill è‡ªåŠ¨æ›´æ–°å¤±è´¥*

ğŸ“… æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')
ğŸ”´ çŠ¶æ€: å·¥ä½œæµæ‰§è¡Œå¤±è´¥

è¯·æ£€æŸ¥å·¥ä½œæµæ—¥å¿—ï¼š
${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          curl -s -X POST \
            "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_USER_ID}" \
            -d "text=${MESSAGE}" \
            -d "parse_mode=Markdown"
